name: Deploy Proyecto VPS

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write 
      
    steps:
      # ðŸš¨ 1. PASO CLAVE: CALCULAR LA RUTA COMPLETA EN MINÃšSCULAS CON BASH ðŸš¨
      - name: Get Lowercase Repository Info
        id: get_repo_info
        run: |
          # 1. Convertir el dueÃ±o del repositorio (Jenni-13) a minÃºsculas
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          
          # 2. El nombre del repo ya es minÃºsculas (proyecto-vps)
          REPO_NAME=${{ github.event.repository.name }}
          
          # 3. Combinar para obtener la ruta completa y guardarla como output
          FULL_REPO_PATH="$OWNER_LOWER/$REPO_NAME"
          echo "full_repo_path=$FULL_REPO_PATH" >> $GITHUB_OUTPUT
      
      - name: Checkout repo
        uses: actions/checkout@v3

      # --- Node Setup con Caching (Soluciona Error 500) ---
      
      - name: Setup Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18
      
      # ðŸš¨ 2. CACHE: Configurar el cachÃ© de dependencias (Solo Backend)
      - name: Cache Node Modules
        uses: actions/cache@v3
        id: npm-cache-backend
        with:
          path: backend/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('backend/package-lock.json') }}
      
      # ðŸš¨ 3. INSTALAR Y PROBAR: Backend (USANDO npm install)
      - name: Install dependencies and Run tests
        run: |
          cd backend
          npm install  # <-- Cambiado de npm ci a npm install
          npm test

      # ðŸš¨ 4. COMPILACIÃ“N: Instalar dependencias y compilar el FRONTEND (USANDO npm install)
      - name: Install Frontend dependencies and Build
        run: |
          cd frontend
          npm install  # <-- Cambiado de npm ci a npm install
          npm run build # Â¡Crea la carpeta dist/ necesaria para el Dockerfile!

      # --- ðŸ³ ConfiguraciÃ³n y Subida a GHCR ---
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }} 

      # ðŸš¨ 5. Build y Push Backend
      - name: Build and Push Backend Image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          file: ./backend/Dockerfile
          tags: ghcr.io/${{ steps.get_repo_info.outputs.full_repo_path }}/backend:${{ github.sha }}

      # ðŸš¨ 6. Build y Push Frontend 
      - name: Build and Push Frontend Image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          file: ./frontend/Dockerfile
          tags: ghcr.io/${{ steps.get_repo_info.outputs.full_repo_path }}/frontend:${{ github.sha }}

      # --- ðŸš€ Despliegue a VPS (Blue-Green) ---
      
      - name: Deploy to VPS (Blue-Green)
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          script: |
            # Moverse al directorio del proyecto
            cd ~/Proyecto-vps

            # SINCRONIZACIÃ“N DE CÃ“DIGO
            git pull origin main
            
            # Asegurar que el Nginx proxy estÃ© corriendo
            docker compose up -d nginx

            # ðŸš¨ 7. EXPORTAR VARIABLES
            export GH_REPO=${{ steps.get_repo_info.outputs.full_repo_path }}
            export IMAGE_TAG=${{ github.sha }}
            
            # Login en el VPS
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # 1. DetecciÃ³n de color activo (Blue-Green)
            if docker ps --filter "name=backend_blue" | grep backend_blue; then
              NEW_COLOR=green
              OLD_COLOR=blue
            else
              NEW_COLOR=blue
              OLD_COLOR=green
            fi
            
            NEW_BACKEND=backend_${NEW_COLOR}
            NEW_FRONTEND=frontend_${NEW_COLOR}
            OLD_BACKEND=backend_${OLD_COLOR}
            OLD_FRONTEND=frontend_${OLD_COLOR}

            echo "Despliegue a color: ${NEW_COLOR}"

            # 2. Pull de la nueva imagen
            docker compose pull ${NEW_BACKEND} ${NEW_FRONTEND}
            
            # 3. Levantar nuevo contenedor (Â¡Esto deberÃ­a funcionar con el SWAP aplicado!)
            docker compose up -d ${NEW_BACKEND} ${NEW_FRONTEND}
            
            # 4. Esperar la salud del nuevo contenedor
            sleep 15
            
            # 5. CRÃTICO: Aplicar la nueva configuraciÃ³n de Nginx (Switch de trÃ¡fico)
            cp ~/Proyecto-vps/nginx/${NEW_COLOR}.conf ~/Proyecto-vps/nginx/default.conf

            # 6. Actualizar Nginx y recargar
            docker exec nginx_proxy nginx -s reload
            
            # 7. Apagar contenedores antiguos
            docker stop ${OLD_BACKEND} ${OLD_FRONTEND} || true
